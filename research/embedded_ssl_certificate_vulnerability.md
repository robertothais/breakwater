# ASTx Embedded SSL Certificate Vulnerability

## Executive Summary

AhnLab Safe Transaction (ASTx) embeds a complete SSL server certificate and private key within its client binary, creating a significant security vulnerability that allows attackers to impersonate AhnLab services with valid SSL certificates.

## Technical Details

### Embedded PKI Infrastructure

ASTx contains three embedded certificate/key pairs obfuscated within the binary:

1. **Server SSL Certificate** (`EMBEDDED_SERVER_CERT_DATA` at 0x08424020, 1950 bytes)
   - Subject: O=ASTxLocal2, CN=ASTx
   - Issuer: O=ASTxRoot2
   - Valid: April 21, 2017 to April 19, 2027
   - Used by internal SSL server on port 55920
   - Loaded via `SSL_CTX_use_certificate()`

2. **Server SSL Private Key** (`EMBEDDED_SERVER_KEY_DATA` at 0x084247c0, 2800 bytes) 
   - 2048-bit RSA private key
   - Matches server certificate (modulus: CFF5778ECD078AFE...)
   - Loaded via `SSL_CTX_use_PrivateKey()`

3. **Trusted CA Certificate** (`EMBEDDED_CA_CERT_DATA` at 0x084252c0, 1825 bytes)
   - Subject/Issuer: O=ASTxRoot2 (self-signed)
   - Valid: June 18, 2015 to June 12, 2038
   - Used to validate certificate chains
   - Does NOT include CA private key (public cert only)

### Deobfuscation Process

All certificates use identical obfuscation:
- XOR each byte with 4 (skip every 5th byte starting from position 0)
- Custom base64 decode with salt=4
- Standard BIO/X509 loading

### SSL Server Architecture

```
ASTx Process → SSL Server (port 55920) → Crypto Operations
             Uses lx.astxsvc.com cert/key
```

## Vulnerability Analysis

### Attack Scenarios

#### 1. DNS Hijacking
- **Public WiFi/Café Networks**: Attacker compromises router
- **Corporate Networks**: Internal DNS poisoning
- **ISP-Level**: BGP hijacking or DNS manipulation  
- **Local Malware**: Modify DNS resolver settings

#### 2. Perfect SSL Impersonation
```
Real:     lx.astxsvc.com → AhnLab Service (valid cert)
Attacker: lx.astxsvc.com → Malicious Server (SAME valid cert)
```

#### 3. Man-in-the-Middle Attacks
- Extract cert/key from any ASTx installation
- Redirect `lx.astxsvc.com` to attacker-controlled server
- Serve malicious content with legitimate AhnLab SSL certificate
- No browser warnings - appears completely legitimate

### Impact Assessment

**Severity**: High
**Scope**: All ASTx users on networks with compromised DNS resolution

**Potential Impacts**:
- Credential harvesting via fake login pages
- Banking transaction manipulation
- Software update hijacking
- Complete traffic interception for targeted users
- Enterprise network compromise

## Code Analysis

### Certificate Loading Functions

```c
// startSSLTCPServer() creates SSL server on port 55920
// Calls chain: startSSLTCPServer → loadSSLCertificateAndKey → certificate extraction

1. extractServerCertificate() (0x080ba4e4) → deobfuscates server certificate
2. extractServerPrivateKey() (0x080ba562) → deobfuscates server private key  
3. SSL_CTX_use_certificate() → installs certificate
4. SSL_CTX_use_PrivateKey() → installs private key
5. SSL_CTX_check_private_key() → verifies cert/key match
```

### Deobfuscation Implementation

Located in functions (renamed after analysis):
- `getTrustedCACertificate` (0x080ba5c2) - extracts CA cert
- `deobfuscateEmbeddedData` (0x080ba2cc) - core XOR deobfuscation
- `extractServerCertificate` (0x080ba4e4) - extracts server cert
- `extractServerPrivateKey` (0x080ba562) - extracts server key
- `loadSSLCertificateAndKey` (0x080bbae0) - loads cert/key into SSL context
- `createSSLContext` (0x080bba9f) - creates SSL context

## Security Design Flaws

### What ASTx Did Wrong
1. **Embedded private keys** in client software
2. **Reusable certificates** across all installations
3. **External domain certificates** instead of localhost-only
4. **Weak obfuscation** easily reversible

### Proper Security Design
1. **Certificate pinning** - hardcode expected certificate hashes
2. **Localhost-only certificates** - CN=localhost, IP=127.0.0.1
3. **Dynamic certificate generation** - unique per installation
4. **No embedded private keys** - use public key validation only
5. **Certificate transparency** monitoring

## Exploitation Requirements

**Attacker needs**:
- Access to any ASTx installation (for cert extraction)
- Network-level control (DNS manipulation)
- Web server to host malicious content

**Attacker does NOT need**:
- Code execution on target machine
- Physical access to target
- Sophisticated technical skills

## Mitigation Recommendations

### For AhnLab
1. **Immediate**: Revoke compromised certificates
2. **Short-term**: Switch to localhost-only certificates  
3. **Long-term**: Implement proper certificate pinning
4. **Architecture**: Redesign to avoid embedded private keys

### For Users/Organizations
1. **Network security**: Monitor DNS resolution for `lx.astxsvc.com`
2. **Certificate monitoring**: Alert on certificate changes
3. **Network segmentation**: Isolate ASTx traffic where possible
4. **Alternative solutions**: Consider other banking security software

## Proof of Concept

The vulnerability can be demonstrated by:
1. Extracting certificates from ASTx binary using reverse engineering tools
2. Setting up web server with extracted cert/key
3. Modifying local DNS to point `lx.astxsvc.com` to attacker server
4. Observing successful SSL connection with no browser warnings

## Timeline

- **Analysis Date**: December 2024
- **Vulnerability Identified**: During reverse engineering of ASTx telemetry system
- **Scope**: Affects all current ASTx installations

## Additional Notes

### Certificate Revocation Limitations
The embedded certificates **cannot be revoked remotely**, which significantly worsens the vulnerability:

**Why revocation is impossible:**
- No CRL Distribution Points in certificate extensions
- No OCSP (Online Certificate Status Protocol) endpoints configured  
- Private PKI infrastructure with no public revocation mechanism
- Certificates lack X509v3 extensions needed for revocation checks

**Impact on remediation:**
- AhnLab cannot remotely revoke compromised certificates if exploitation is detected
- Emergency fix requires pushing software updates to all installations
- Users who don't update remain vulnerable indefinitely
- Server certificate remains valid until **April 19, 2027** (2.5+ years from now)
- CA certificate valid until **June 12, 2038** (14+ years from now)

This means even after discovery of active exploitation, the certificates remain valid and usable by attackers until every single ASTx installation is updated with new binaries.

### Separate RSA Key Pair
ASTx also embeds a separate RSA key pair (found in appconfig.xml) that is distinct from the SSL certificates:
- 2048-bit RSA key pair with modulus starting DD6E4BEC9EC5...
- Used for application-level crypto operations (telemetry data encryption/signing)
- Not wrapped in a certificate, stored as raw PEM keys
- Represents a separate security issue from the SSL certificate vulnerability

### Certificate Extraction
Successfully extracted and verified all embedded certificates:
- Certificates stored at specific memory addresses in astxdaemon binary
- Extraction tool: `/targets/astx/tools/extract_embedded_certs.py`
- Extracted certificates: `/targets/astx/analysis/certs/extracted/`

## References

- ASTx Binary Analysis: `/experiments/oracle/`
- Certificate Extraction Tool: `/targets/astx/tools/extract_embedded_certs.py`
- Ghidra Function Analysis: Renamed functions in astxdaemon
- Related Research: Korean banking software PKI implementations